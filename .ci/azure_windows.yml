jobs:
  - job: win_vs2017
    displayName: Windows Visual Studio 2017
    timeoutInMinutes: 0
    variables:
      BUILD_DIR: '$(Agent.WorkFolder)\build'
      VCPKG_DIR: '$(Agent.WorkFolder)\vcpkg'
      VCVARSALL: '%ProgramFiles(x86)%\Microsoft Visual Studio\2017\Enterprise\VC\Auxiliary\Build\vcvarsall.bat'
      PLATFORM: x64
      ARCHITECTURE: 'x86_amd64'
      GENERATOR: 'Visual Studio 15 2017 Win64'
      CONFIGURATION: 'Release'
      VCPKG_ROOT: 'C:\vcpkg'
    pool:
      vmImage: 'vs2017-win2016'
    steps:
      - script: |
          vcpkg.exe install flatbuffers zeromq --triplet %PLATFORM%-windows && vcpkg.exe list
        displayName: 'Install Dependencies'
      - script: |
          rmdir %VCPKG_ROOT%\downloads /S /Q
          rmdir %VCPKG_ROOT%\packages /S /Q
        displayName: 'Free Up Space'
      - script: |
          call "%VCVARSALL%" %ARCHITECTURE%
          set PATH=%VCPKG_ROOT%\installed\%PLATFORM%-windows\bin;%PATH%
          mkdir %BUILD_DIR% && cd %BUILD_DIR%
          cmake $(Build.SourcesDirectory) -G"%GENERATOR%" -DCMAKE_TOOLCHAIN_FILE=%VCPKG_ROOT%\scripts\buildsystems\vcpkg.cmake -DVCPKG_APPLOCAL_DEPS=ON -DSIMPLE_BUILD_TESTS=ON -DSIMPLE_BUILD_EXAMPLES=ON
        displayName: 'CMake Configuration'
      - script: cd %BUILD_DIR% && cmake --build . --config %CONFIGURATION%
        displayName: 'Build Library'
      - script: cd %BUILD_DIR% && ctest -R simple_tests -C %CONFIGURATION% -T Test
        displayName: 'Run Unit Tests'
      - task: PublishTestResults@2
        inputs:
          testResultsFormat: 'CTest'
          testResultsFiles: '**/Test.xml'
          searchFolder: '$(Agent.WorkFolder)\build'
        condition: succeededOrFailed()
